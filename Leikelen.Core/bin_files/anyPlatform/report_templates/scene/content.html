
<html>
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <script>
        //console.log("el inicio");
     Function.prototype.bind = Function.prototype.bind || function (thisp) {
        var fn = this;
        return function () {
            return fn.apply(thisp, arguments);
        };
    };
    //console.log("el fin del inicio");
    </script>
    <script src="jquery-1.11.0.min.js" type="text/javascript"></script>
    <script src="Chart.bundle.min.js" type="text/javascript"></script>
    <script src="d3.min.js" type="text/javascript"></script>
    <script src="helpers.js" type="text/javascript"></script>
    <script src="functions.js" type="text/javascript"></script>
</head>
<body>
    <h1>Reporte de la Presentacion</h1>
    <h3>Posturas por estudiante</h3>
    <p>A continuación se muestra la cantidad de tiempo (porcentualmente) de cada postura</p>
    <div style="width:900px;height:600;">
        <canvas id="discretes" style="width:900px;height:600px"></canvas>
    </div>

    <h3>Voz, Inclinación del cuerpo y orientación del cuello</h3>
    <p>A continuación se muestra el tiempo que estuvo hablando, la inclinación de su cuerpo y si estuvo mirando al público</p>
    <div style="width:900px;height:600;">
        <canvas id="others" style="width:900px;height:600px"></canvas>
    </div>

    <h3>Distancias entre los participantes</h3>
    <p>A continuación se muestran los tipos de distancias entre los participantes</p>
    <div style="width:900px;height:600;">
        <canvas id="proxemics" style="width:900px;height:600px"></canvas>
    </div>

    <div id="ModalIntervalsDiv"></div>

    <hr/><hr/><hr/><hr/><hr/><hr/><hr/><hr/>
    <div id="SubmodalIntervalsDiv"></div>


    <hr/><hr/><hr/><hr/><hr/><hr/><hr/><hr/>
    <h1>Eventos</h1>
    <p>A continuación se muestran los gráficos de eventos por cada tipo y subtipo. 
    Los gráficos contienen 100 o menos puntos (en caso de tener menos de 100) por un tema de visualización y rendimiento, 
    para esto se aplicó un proceso de decimación</p>
    <div id="SubmodalEventsDiv"></div>
    <br/><br/>
    <hr/><hr/><hr/><hr/><hr/><hr/><hr/><hr/>
    <h1>Treemaps</h1>
    <div id="treemaps"></div>
</body>
<script>
    //console.log("what paso");
  $(function () {
    $.getJSON("dataJson.json")
        .done(function(data){
            var dScene = Date.parse("1970-01-01T" + data["scene"]["Duration"] + "Z");
            var cScene = new Date(dScene);
            //var sScene = c;
            var sScene = cScene.getUTCHours()*60*60+cScene.getUTCMinutes()*60+cScene.getUTCSeconds()+cScene.getUTCMilliseconds()/1000.0;

            /*var optionsPercentage = {
                animation: {
                        duration: 0
                    }
                };
            var optionsTime = {
                scales: {
                    xAxes: [{
                        type: 'time',
                        time: {
                            unit: 'second',
                            displayFormats: {
                                second: 'mm:ss'
                            }
                        }
                    }]
                }
            };*/

            //console.log("holi a crear discrete");
            /*Discrete postures*/
            var labels = getLabels(data["intervals"], ["Discrete Posture"], false);
            var persons = getPersonData(data["intervals"], ["Discrete Posture"], false, sScene);
            var barChartData = createBarChartData(persons, labels);
            

            new Chart(document.getElementById('discretes').getContext('2d'), {
                type: 'bar',
                data: barChartData,
                options: {
                    animation: {
                        duration: 0
                    }
                }
            })
            //console.log("a crear voice");
            /*Voice, Neck Orientation, Lean, AccProxemic, Proxemic*/
            labels = getLabels(data["intervals"], ["Voice", "Neck Orientation", "Lean"], true);
            persons = getPersonData(data["intervals"], ["Voice", "Neck Orientation", "Lean"], true, sScene);
            barChartData = createBarChartData(persons, labels);

            new Chart(document.getElementById('others').getContext('2d'), {
                type: 'bar',
                data: barChartData,
                options: {
                    animation: {
                        duration: 0
                    }
                }
            })

            //console.log("proxemics");
            /*Proxemic*/
            labels = getLabels(data["intervals"], ["AccProxemic", "Proxemic"], true);
            persons = getPersonData(data["intervals"], ["AccProxemic", "Proxemic"], true, sScene);
            barChartData = createBarChartData(persons, labels);

            new Chart(document.getElementById('proxemics').getContext('2d'), {
                type: 'bar',
                data: barChartData,
                options: {
                    animation: {
                        duration: 0
                    }
                }
            })
var styleStr = "style='width:900px;height:100px;'"
            

            try{            //console.log("bar charts creados");
            var numInterval = 0;
            
            Object.keys(data["intervalList"]).map(function(person, iPerson){
                $("#ModalIntervalsDiv").append("<br/><br/><hr/><hr/><h1>Persona: "+person+"</h1><br/>")
                Object.keys(data["intervalList"][person]).map(function(modal, iModal){
                    $("#ModalIntervalsDiv").append("<br/><br/><h2>Tipo modal: "+modal+"</h2>");

                    Object.keys(data["intervalList"][person][modal]).map(function(submodal, iSubmodal){
                        if(data["intervalList"][person][modal][submodal] != null){
                            //console.log("no es null");
                            $("#ModalIntervalsDiv").append("<div><span style='width:20px;height20px;background:"+colors[iSubmodal%colors.length]+"'>[ ]</span>"+submodal+"<br/></div>");
                        }
                    });
                    $("#ModalIntervalsDiv").append("<br/><div id='divinter"+numInterval+"' "+styleStr+"></div>"); //<h3>"+submodal+"</h3>
                    $("#divinter"+numInterval).append("<canvas id='canvasinter"+numInterval+"' "+styleStr+"></canvas>");
                    //console.log("vamos a crear los datos");
                    var dataOfChart = createModalIntervalsGraph(data["intervalList"][person][modal],
                            sScene,
                            modal,
                            iModal);
                    //console.log("datos creados, a graficar");
                    //console.log(dataOfChart);
                    new Chart(document.getElementById("canvasinter"+numInterval).getContext('2d'), dataOfChart);
                    numInterval++;
                    //console.log("holiwiws");
                })
            });

                
            } catch(ex){console.log("error: "+ex.message);}

            try{
            //console.log("aaa crear los otros intervalos de submodal separados");
            var numInterval = 0;
            Object.keys(data["intervalList"]).map(function(person, iPerson){
                $("#SubmodalIntervalsDiv").append("<br/><br/><hr/><hr/><h1>Persona: "+person+"</h1><br/>")
                Object.keys(data["intervalList"][person]).map(function(modal, iModal){
                    $("#SubmodalIntervalsDiv").append("<br/><br/><h2>Tipo modal: "+modal+"</h2>");
                    Object.keys(data["intervalList"][person][modal]).map(function(submodal, iSubmodal){
                        if(data["intervalList"][person][modal][submodal] != null){
                            //console.log("no es null");
                            $("#SubmodalIntervalsDiv").append("<br/><div id='subdivinter"+numInterval+"' "+styleStr+"><h3>"+submodal+"</h3></div>"); //
                            $("#subdivinter"+numInterval).append("<canvas id='subcanvasinter"+numInterval+"' "+styleStr+"></canvas>");

                            //console.log("a crear datos");
                            var dataOfChart = createSubModalIntervalsGraph(data["intervalList"][person][modal][submodal],
                                    sScene,
                                    submodal,
                                    iSubmodal);
                            //console.log(dataOfChart);
                            new Chart(document.getElementById("subcanvasinter"+numInterval).getContext('2d'), dataOfChart);
                            numInterval++;
                        }
                    })
                })
            });
            } catch(ex){console.log("error: "+ex.message);}

            

            //console.log("termino intervalos");
            try{
            /*Eventssss*/
            var numEvents = 0;
            Object.keys(data["eventList"]).map(function(person, iPerson){
                $("#SubmodalEventsDiv").append("<br/><br/><hr/><hr/><h1>Persona: "+person+"</h1><br/>")
                //console.log("holi");
                Object.keys(data["eventList"][person]).map(function(modal, iModal){
                    $("#SubmodalEventsDiv").append("<br/><br/><h2>Tipo modal: "+modal+"</h2>");
                    Object.keys(data["eventList"][person][modal]).map(function(submodal, iSubmodal){
                        if(data["eventList"][person][modal][submodal] != null){
                            //console.log("no es null");
                            $("#SubmodalEventsDiv").append("<br/><div id='subdivev"+numEvents+"' "+styleStr+"><h3>"+submodal+"</h3></div>"); //
                            $("#subdivev"+numEvents).append("<canvas id='subcanvasev"+numEvents+"' "+styleStr+"></canvas>");
                            //console.log("holi2");
                            chartData = [];
                            var decimationFactor = parseInt(String((data["eventList"][person][modal][submodal].length/100)));
                            var decimationActual = 0;
                            var decimationArray = [];
                            //console.log("holi3");

                            for(var iEv in data["eventList"][person][modal][submodal]){
                                var myx = 1;
                                //console.log("holi in for");
                                if(typeof(data["eventList"][person][modal][submodal][iEv]["Value"]) != typeof(undefined)){
                                    //console.log("es undefined?");
                                    myx = data["eventList"][person][modal][submodal][iEv]["Value"];
                                }
                                decimationArray.push(myx);
                                if(decimationActual == decimationFactor || decimationActual == data["eventList"][person][modal][submodal].length -1 ){
                                    var realX = 0;
                                    for(var i in decimationArray){
                                        realX = realX + decimationArray[i];
                                    }
                                    realX = realX/decimationArray.length;
                                    
                                    var timeEvent = data["eventList"][person][modal][submodal][iEv]["EventTime"];
                                    var dEvent = Date.parse("1970-01-01T" + timeEvent + "Z");
                                    var cEvent = new Date(dEvent);
                                    var sEvent = cEvent.getUTCHours()*60*60+cEvent.getUTCMinutes()*60+cEvent.getUTCSeconds()+cEvent.getUTCMilliseconds()/1000.0;


                                    chartData.push({y: realX, x: sEvent});

                                    decimationActual = 0;
                                    decimationArray = [];
                                }
                                decimationActual++;
                                
                            }
                            //console.log(chartData);
                            //console.log(dataOfChart);
                            //console.log("a crear chart eve");
                            new Chart(document.getElementById("subcanvasev"+numEvents).getContext('2d'), {
                                type: 'line',
                                data: {
                                    datasets: [{
                                        data: chartData
                                    }]
                                },
                                options: {
                                    animation: {
                                        duration: 0
                                    },
                                    legend : {
                                        display : false
                                    },
                                    scales: {
                                        xAxes: [{
                                            type: 'linear',
                                            position: 'bottom',
                                            ticks : {
                                                beginAtzero :true,
                                                max: sScene,
                                                min: 0, 
                                                callback: function(value, index, values){
                                                    return parseInt(String(value/60)+":"+parseInt(String(((value/60)-parseInt(String(value/60)))*60)))
                                                }
                                            }
                                        }],
                                        yAxes: [{
                                            type: 'linear',
                                        }]
                                    }
                                }
                            });
                            numEvents++;
                        }
                    })
                })
            });
                } catch(ex){console.log("error events: "+ex.message);}
            
            //console.log("termino");
            
            var treeData = {};
            for(var inter in data["intervals"]){
                var interval = data["intervals"][inter];
                if(interval["ModalName"] != "Discrete Posture")
                    continue;
                if(!(interval["PersonName"] in treeData)){
                    treeData[interval["PersonName"]] = {
                        "name": interval["PersonName"],
                        "children": []
                    };
                }
                /*var ModalItIs = false;
                var childNumber = 0;
                for(var child in treeData[interval["PersonName"]]["children"]){
                    if(treeData[interval["PersonName"]]["children"][child]["name"] == interval["ModalName"]){
                        ModalItIs = true;
                        childNumber = child;
                    }
                }
                if(!ModalItIs){
                    childNumber = treeData[interval["PersonName"]]["children"].push({
                        "name": interval["ModalName"],
                        "children": []
                    });
                    childNumber = childNumber -1;
                }*/
                //console.log(childNumber);
                //console.log(interval["ModalName"]);
                //console.log(treeData[interval["PersonName"]]["children"]);
                var dInter = Date.parse("1970-01-01T" + interval["TotalDuration"] + "Z");
                var cInter = new Date(dInter);
                var sInter = parseInt(String(cInter.getUTCHours()*60*60+cInter.getUTCMinutes()*60+cInter.getUTCSeconds()+cInter.getUTCMilliseconds()/1000.0));
                treeData[interval["PersonName"]]["children"]/*[childNumber]["children"]*/.push({
                    "name": interval["SubModalName"],
                    /*"size": sInter*/
                    "children": [{
                        "name": interval["SubModalName"],
                        "size": sInter
                    }]
                });
            }
            for(var p in treeData){
                $("#treemaps").append("<h2>Para persona: "+p+"</h2><svg id='treemap"+p+"' width='900' height='900'></svg>")
                createTreeMap("treemap"+p, treeData[p]);
            }


        });
  });
</script>
</html>