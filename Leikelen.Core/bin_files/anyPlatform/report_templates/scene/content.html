
<html>
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <script>
     Function.prototype.bind = Function.prototype.bind || function (thisp) {
        var fn = this;
        return function () {
            return fn.apply(thisp, arguments);
        };
    };
    </script>
    <script src="jquery-1.11.0.min.js"></script>
    <script src="Chart.bundle.min.js"></script>
    <script src="helpers.js"></script>
</head>
<body>
    <h1>Reporte de la Presentacion</h1>
    <h3>Posturas por estudiante</h3>
    <p>A continuación se muestra la cantidad de tiempo (porcentualmente) de cada postura</p>
    <div style="width:900px;height:600;">
        <canvas id="discretes" style="width:900px;height:600px"></canvas>
    </div>

    <h3>Voz, Inclinación del cuerpo y orientación del cuello</h3>
    <p>A continuación se muestra el tiempo que estuvo hablando, la inclinación de su cuerpo y si estuvo mirando al público</p>
    <div style="width:900px;height:600;">
        <canvas id="others" style="width:900px;height:600px"></canvas>
    </div>

    <h3>Distancias entre los participantes</h3>
    <p>A continuación se muestran los tipos de distancias entre los participantes</p>
    <div style="width:900px;height:600;">
        <canvas id="proxemics" style="width:900px;height:600px"></canvas>
    </div>

    <div id="ModalIntervalsDiv"></div>

    <hr/><hr/><hr/><hr/><hr/><hr/><hr/><hr/>
    <div id="SubmodalIntervalsDiv"></div>


    <hr/><hr/><hr/><hr/><hr/><hr/><hr/><hr/>
    <h1>Eventos</h1>
    <p>A continuación se muestran los gráficos de eventos por cada tipo y subtipo. 
    Los gráficos contienen 100 o menos puntos (en caso de tener menos de 100) por un tema de visualización y rendimiento, 
    para esto se aplicó un proceso de decimación</p>
    <div id="SubmodalEventsDiv"></div>
</body>
<script>
    var colors = [
        'rgba(255, 0, 0, 0.5)',
        'rgba(0, 255, 0, 0.5)',
        'rgba(0, 0, 255, 0.5)',
        'rgba(126, 126, 126, 0.5)',
        'rgba(0, 126, 126, 0.5)',
        'rgba(126, 126, 0, 0.5)',
        'rgba(126, 0, 126, 0.5)',
        'rgba(55, 126, 55, 0.5)'
    ]
    function getLabels(data, modalNames, prefix){
        var labels = [];
        data.map(function(b) {
            if (modalNames.has(b["ModalName"])){
                if(prefix){
                    if(!labels.has(b["ModalName"]+" - "+b["SubModalName"]))
                        labels.push(b["ModalName"]+" - "+b["SubModalName"]);
                }
                else{
                    if(!labels.has(b["SubModalName"]))
                        labels.push(b["SubModalName"]);
                }
            }
        });
        return labels;
    }
    function getPersonData(data, modalNames, prefix, durationScene){
        var persons = {};
        data.map(function(b) {
            if (modalNames.has(b["ModalName"])){
                var d = Date.parse("1970-01-01T" + b["TotalDuration"] + "Z");
                var c = new Date(d);
                var s = c;
                //var s = c.getUTCHours()*60*60+c.getUTCMinutes()*60+c.getUTCSeconds()+c.getUTCMilliseconds()/1000.0;
                if(! (b["PersonName"] in persons))
                    persons[b["PersonName"]] = {}
                if(durationScene != 0)
                    s = s/durationScene;
                if(prefix)
                    persons[b["PersonName"]][b["ModalName"]+" - "+b["SubModalName"]] = s;
                else
                    persons[b["PersonName"]][b["SubModalName"]] = s;
            }
        });
        return persons;
    }
    function createBarChartData(persons, labels){
        var barChartData={};
        barChartData.labels = labels;
        barChartData.datasets = [];
        Object.keys(persons).map(function(p, i){
            d = {};
            d.label = p;
            d.borderWidth = 1;
            d.backgroundColor = colors[i]
            d.data = [];
            labels.map(function(l){
                if(l in persons[p]){
                    d.data.push(persons[p][l]);
                }else{
                    d.data.push(0);
                }
            });
            barChartData.datasets.push(d);
        });
        return barChartData;
    }
    function createModalIntervalsGraph(intervals, durationScene, name, i){
        var intervalsData={};
        intervalsData.type = 'line';
        intervalsData.data = {};
        intervalsData.data.datasets = [];
        intervalsData.options = {
            animation: {
                duration: 0
            },
            legend : {
                display : false
            },
            scales: {
                xAxes: [{
                    type: 'linear',
                    position: 'bottom',
                    ticks : {
                        beginAtzero :true,
                        min: 0,
                        max: durationScene,
                        callback: function(value, index, values){
                            return Math.trunc(value/60)+":"+Math.round(((value/60)-Math.trunc(value/60))*60)
                        }
                        
                    },
                    /*time: {
                        min: 0,
                        max: durationScene,
                        unit: 'second',
                        displayFormats: {
                            second: 'mm:ss'
                        }
                    }*/
                }],
                yAxes : [{
                    display: false
                    /*scaleLabel : {
                        display : false
                    }*/,
                    ticks : {
                        beginAtZero :true,
                        max : 1
                    }
                }]
            }
        };
        Object.keys(intervals).map(function(submodal, iSubmodal){
            
            if(intervals[submodal] != null){
                for(var iInterval in intervals[submodal]){
                    d = {};
                    d.backgroundColor = colors[iSubmodal%colors.length];
                    d.fill = true;
                    d.borderWidth = 0;
                    d.pointRadius = 0;
                    d.labels = [submodal];
                    var dStart = Date.parse("1970-01-01T" + intervals[submodal][iInterval]["StartTime"] + "Z");
                    var cStart = new Date(dStart);
                    var sStart = cStart.getUTCHours()*60*60+cStart.getUTCMinutes()*60+cStart.getUTCSeconds()+cStart.getUTCMilliseconds()/1000.0;
                    var dEnd = Date.parse("1970-01-01T" + intervals[submodal][iInterval]["EndTime"] + "Z");
                    var cEnd = new Date(dEnd);
                    var sEnd = cEnd.getUTCHours()*60*60+cEnd.getUTCMinutes()*60+cEnd.getUTCSeconds()+cEnd.getUTCMilliseconds()/1000.0;

                    d.data = [{
                        x: sStart,
                        y: 1
                    },{
                        x: sEnd,
                        y: 1
                    }];
                    intervalsData.data.datasets.push(d);
                }
            }
            
        })
        
        return intervalsData;
    }
    function createSubModalIntervalsGraph(intervals, durationScene, name, i){
        var intervalsData={};
        intervalsData.type = 'line';
        intervalsData.data = {};
        intervalsData.data.datasets = [];
        intervalsData.options = {
            animation: {
                duration: 0
            },
            legend : {
                display : false
            },
            scales: {
                xAxes: [{
                    type: 'linear',
                    position: 'bottom',
                    ticks : {
                        beginAtzero :true,
                        min: 0,
                        max: durationScene,
                        callback: function(value, index, values){
                            return Math.trunc(value/60)+":"+Math.round(((value/60)-Math.trunc(value/60))*60)
                        }
                        
                    }
                    /*time: {
                        min: 0,
                        max: durationScene,
                        unit: 'second',
                        displayFormats: {
                            second: 'mm:ss'
                        }
                    }*/
                }],
                yAxes : [{
                    display: false
                    /*scaleLabel : {
                        display : false
                    }*/,
                    ticks : {
                        beginAtZero :true,
                        max : 1
                    }
                }]
            }
        };
        //console.log(name);
        //console.log();
        for(var iInterval in intervals){
            d = {};
            d.backgroundColor = colors[i%colors.length];
            d.fill = true;
            d.borderWidth = 0;
            d.pointRadius = 0;
            var dStart = Date.parse("1970-01-01T" + intervals[iInterval]["StartTime"] + "Z");
            var cStart = new Date(dStart);
            var sStart = cStart.getUTCHours()*60*60+cStart.getUTCMinutes()*60+cStart.getUTCSeconds()+cStart.getUTCMilliseconds()/1000.0;
            var dEnd = Date.parse("1970-01-01T" + intervals[iInterval]["EndTime"] + "Z");
            var cEnd = new Date(dEnd);
            var sEnd = cEnd.getUTCHours()*60*60+cEnd.getUTCMinutes()*60+cEnd.getUTCSeconds()+cEnd.getUTCMilliseconds()/1000.0;

            d.data = [{
                x: sStart,
                y: 1
            },{
                x: sEnd,
                y: 1
            }];
            intervalsData.data.datasets.push(d);
        }
        
        return intervalsData;
    }
  $(function () {
    $.getJSON("dataJson.json")
        .done(function(data){
            var dScene = Date.parse("1970-01-01T" + data["scene"]["Duration"] + "Z");
            var cScene = new Date(dScene);
            //var sScene = c;
            var sScene = cScene.getUTCHours()*60*60+cScene.getUTCMinutes()*60+cScene.getUTCSeconds()+cScene.getUTCMilliseconds()/1000.0;

            var optionsPercentage = {
                animation: {
                        duration: 0
                    }
                };
            var optionsTime = {
                scales: {
                    xAxes: [{
                        type: 'time',
                        time: {
                            unit: 'second',
                            displayFormats: {
                                second: 'mm:ss'
                            }
                        }
                    }]
                }
            };


            /*Discrete postures*/
            var labels = getLabels(data["intervals"], ["Discrete Posture"], false);
            var persons = getPersonData(data["intervals"], ["Discrete Posture"], false, sScene);
            var barChartData = createBarChartData(persons, labels);
            

            new Chart(document.getElementById('discretes').getContext('2d'), {
                type: 'bar',
                data: barChartData,
                options: {
                    animation: {
                        duration: 0
                    }
                }
            })
            /*Voice, Neck Orientation, Lean, AccProxemic, Proxemic*/
            labels = getLabels(data["intervals"], ["Voice", "Neck Orientation", "Lean"], true);
            persons = getPersonData(data["intervals"], ["Voice", "Neck Orientation", "Lean"], true, sScene);
            barChartData = createBarChartData(persons, labels);

            new Chart(document.getElementById('others').getContext('2d'), {
                type: 'bar',
                data: barChartData,
                options: {
                    animation: {
                        duration: 0
                    }
                }
            })

            /*Proxemic*/
            labels = getLabels(data["intervals"], ["AccProxemic", "Proxemic"], true);
            persons = getPersonData(data["intervals"], ["AccProxemic", "Proxemic"], true, sScene);
            barChartData = createBarChartData(persons, labels);

            new Chart(document.getElementById('proxemics').getContext('2d'), {
                type: 'bar',
                data: barChartData,
                options: {
                    animation: {
                        duration: 0
                    }
                }
            })


            var numInterval = 0;
            var styleStr = "style='width:900px;height:100px;'"
            Object.keys(data["intervalList"]).map(function(person, iPerson){
                $("#ModalIntervalsDiv").append("<br/><br/><hr/><hr/><h1>Persona: "+person+"</h1><br/>")
                Object.keys(data["intervalList"][person]).map(function(modal, iModal){
                    $("#ModalIntervalsDiv").append("<br/><br/><h2>Tipo modal: "+modal+"</h2>");

                    Object.keys(data["intervalList"][person][modal]).map(function(submodal, iSubmodal){
                        if(data["intervalList"][person][modal][submodal] != null){
                            //console.log("no es null");
                            $("#ModalIntervalsDiv").append("<div><span style='width:20px;height20px;background:"+colors[iSubmodal%colors.length]+"'>[ ]</span>"+submodal+"<br/></div>");
                        }
                    });
                    $("#ModalIntervalsDiv").append("<br/><div id='divinter"+numInterval+"' "+styleStr+"></div>"); //<h3>"+submodal+"</h3>
                    $("#divinter"+numInterval).append("<canvas id='canvasinter"+numInterval+"' "+styleStr+"></canvas>");

                    var dataOfChart = createModalIntervalsGraph(data["intervalList"][person][modal],
                            sScene,
                            modal,
                            iModal);
                    //console.log(dataOfChart);
                    new Chart(document.getElementById("canvasinter"+numInterval).getContext('2d'), dataOfChart);
                    numInterval++;
                    //console.log("holiwiws");
                })
            });


            var numInterval = 0;
            Object.keys(data["intervalList"]).map(function(person, iPerson){
                $("#SubmodalIntervalsDiv").append("<br/><br/><hr/><hr/><h1>Persona: "+person+"</h1><br/>")
                Object.keys(data["intervalList"][person]).map(function(modal, iModal){
                    $("#SubmodalIntervalsDiv").append("<br/><br/><h2>Tipo modal: "+modal+"</h2>");
                    Object.keys(data["intervalList"][person][modal]).map(function(submodal, iSubmodal){
                        if(data["intervalList"][person][modal][submodal] != null){
                            //console.log("no es null");
                            $("#SubmodalIntervalsDiv").append("<br/><div id='subdivinter"+numInterval+"' "+styleStr+"><h3>"+submodal+"</h3></div>"); //
                            $("#subdivinter"+numInterval).append("<canvas id='subcanvasinter"+numInterval+"' "+styleStr+"></canvas>");

                            var dataOfChart = createSubModalIntervalsGraph(data["intervalList"][person][modal][submodal],
                                    sScene,
                                    submodal,
                                    iSubmodal);
                            //console.log(dataOfChart);
                            new Chart(document.getElementById("subcanvasinter"+numInterval).getContext('2d'), dataOfChart);
                            numInterval++;
                        }
                    })
                })
            });

            //console.log("termino intervalos");

            /*Eventssss*/
            var numEvents = 0;
            Object.keys(data["eventList"]).map(function(person, iPerson){
                $("#SubmodalEventsDiv").append("<br/><br/><hr/><hr/><h1>Persona: "+person+"</h1><br/>")
                Object.keys(data["eventList"][person]).map(function(modal, iModal){
                    $("#SubmodalEventsDiv").append("<br/><br/><h2>Tipo modal: "+modal+"</h2>");
                    Object.keys(data["eventList"][person][modal]).map(function(submodal, iSubmodal){
                        if(data["eventList"][person][modal][submodal] != null){
                            //console.log("no es null");
                            $("#SubmodalEventsDiv").append("<br/><div id='subdivev"+numEvents+"' "+styleStr+"><h3>"+submodal+"</h3></div>"); //
                            $("#subdivev"+numEvents).append("<canvas id='subcanvasev"+numEvents+"' "+styleStr+"></canvas>");
                            
                            chartData = [];
                            var decimationFactor = Math.trunc(data["eventList"][person][modal][submodal].length/100);
                            var decimationActual = 0;
                            var decimationArray = [];

                            for(var iEv in data["eventList"][person][modal][submodal]){
                                var myx = 1;
                                if(typeof(data["eventList"][person][modal][submodal][iEv]["Value"]) != typeof(undefined)){
                                    myx = data["eventList"][person][modal][submodal][iEv]["Value"];
                                }
                                decimationArray.push(myx);
                                if(decimationActual == decimationFactor || decimationActual == data["eventList"][person][modal][submodal].length -1 ){
                                    var realX = 0;
                                    for(var i in decimationArray){
                                        realX = realX + decimationArray[i];
                                    }
                                    realX = realX/decimationArray.length;
                                    
                                    var timeEvent = data["eventList"][person][modal][submodal][iEv]["EventTime"];
                                    var dEvent = Date.parse("1970-01-01T" + timeEvent + "Z");
                                    var cEvent = new Date(dEvent);
                                    var sEvent = cEvent.getUTCHours()*60*60+cEvent.getUTCMinutes()*60+cEvent.getUTCSeconds()+cEvent.getUTCMilliseconds()/1000.0;


                                    chartData.push({y: realX, x: sEvent});

                                    decimationActual = 0;
                                    decimationArray = [];
                                }
                                decimationActual++;
                                
                            }
                            //console.log(chartData);
                            //console.log(dataOfChart);
                            new Chart(document.getElementById("subcanvasev"+numEvents).getContext('2d'), {
                                type: 'line',
                                data: {
                                    datasets: [{
                                        data: chartData
                                    }]
                                },
                                options: {
                                    animation: {
                                        duration: 0
                                    },
                                    legend : {
                                        display : false
                                    },
                                    scales: {
                                        xAxes: [{
                                            type: 'linear',
                                            position: 'bottom',
                                            ticks : {
                                                beginAtzero :true,
                                                max: sScene,
                                                min: 0, 
                                                callback: function(value, index, values){
                                                    return Math.trunc(value/60)+":"+Math.round(((value/60)-Math.trunc(value/60))*60)
                                                }
                                            }
                                        }],
                                        yAxes: [{
                                            type: 'linear',
                                        }]
                                    }
                                }
                            });
                            numEvents++;
                        }
                    })
                })
            });
            
            //console.log("termino");

        });
  });
</script>
</html>