
<html>
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <script>
     Function.prototype.bind = Function.prototype.bind || function (thisp) {
        var fn = this;
        return function () {
            return fn.apply(thisp, arguments);
        };
    };
    </script>
    <script src="jquery-1.11.0.min.js"></script>
    <script src="Chart.bundle.min.js"></script>
    <script src="d3.min.js"></script>
    <script src="helpers.js"></script>
    <script src="functions.js" type="text/javascript"></script>
</head>
<body>
    <h1>Reporte de la Presentacion</h1>
    <h3>Posturas por estudiante</h3>
    <p>A continuación se muestra la cantidad de tiempo (porcentualmente) de cada postura</p>
    <div style="width:900px;height:600;">
        <canvas id="discretes" style="width:900px;height:600px"></canvas>
    </div>

    <h3>Voz, Inclinación del cuerpo y orientación del cuello</h3>
    <p>A continuación se muestra el tiempo que estuvo hablando, la inclinación de su cuerpo y si estuvo mirando al público</p>
    <div style="width:900px;height:600;">
        <canvas id="others" style="width:900px;height:600px"></canvas>
    </div>

    <h3>Distancias entre los participantes</h3>
    <p>A continuación se muestran los tipos de distancias entre los distintos participantes</p>
    <div style="width:900px;height:600;">
        <canvas id="proxemics" style="width:900px;height:600px"></canvas>
    </div>

    <div id="ModalIntervalsDiv"></div>

    <hr/><hr/><hr/><hr/><hr/><hr/><hr/><hr/>
    <div id="SubmodalIntervalsDiv"></div>

        <hr/><hr/><hr/><hr/><hr/><hr/><hr/><hr/>
    <h1>Eventos</h1>
    <p>A continuación se muestran los gráficos de eventos por cada tipo y subtipo. 
    Los gráficos contienen 100 o menos puntos (en caso de tener menos de 100) por un tema de visualización y rendimiento, 
    para esto se aplicó un proceso de decimación</p>
    <div id="SubmodalEventsDiv"></div>
    <br/><br/>
    <hr/><hr/><hr/><hr/><hr/><hr/><hr/><hr/>
    <h1>Treemap</h1>
    <svg id='treemap' width='900' height='900'></svg>
</body>
<script>
  $(function () {
    $.getJSON("dataJson.json")
        .done(function(data){

            var dScene = Date.parse("1970-01-01T" + data["scene"]["Duration"] + "Z");
            var cScene = new Date(dScene);
            //var sScene = c;
            var sScene = cScene.getUTCHours()*60*60+cScene.getUTCMinutes()*60+cScene.getUTCSeconds()+cScene.getUTCMilliseconds()/1000.0;


            /*Discrete postures*/
            var labels = getLabels(data["intervals"], ["Discrete Posture"], false);
            var persons = getPersonData(data["intervals"], ["Discrete Posture"], false, sScene);
            var barChartData = createBarChartData(persons, labels);
            

            new Chart(document.getElementById('discretes').getContext('2d'), {
                type: 'bar',
                data: barChartData,
                options: {
                    animation: {
                        duration: 0
                    }
                }
            })
            /*Voice, Neck Orientation, Lean, AccProxemic, Proxemic*/
            labels = getLabels(data["intervals"], ["Voice", "Neck Orientation", "Lean"], true);
            persons = getPersonData(data["intervals"], ["Voice", "Neck Orientation", "Lean"], true, sScene);
            barChartData = createBarChartData(persons, labels);

            new Chart(document.getElementById('others').getContext('2d'), {
                type: 'bar',
                data: barChartData,
                options: {
                    animation: {
                        duration: 0
                    }
                }
            })

            /*Proxemic*/
            labels = getLabels(data["intervals"], ["AccProxemic", "Proxemic"], true);
            persons = getPersonData(data["intervals"], ["AccProxemic", "Proxemic"], true, sScene);
            barChartData = createBarChartData(persons, labels);

            new Chart(document.getElementById('proxemics').getContext('2d'), {
                type: 'bar',
                data: barChartData,
                options: {
                    animation: {
                        duration: 0
                    }
                }
            })


            /*Graficos intervalos*/
            var numInterval = 0;
            var styleStr = "style='width:900px;height:100px;'"
            Object.keys(data["intervalList"]).map(function(modal, iModal){
                $("#ModalIntervalsDiv").append("<br/><br/><h2>Tipo modal: "+modal+"</h2>");
                
                
                Object.keys(data["intervalList"][modal]).map(function(submodal, iSubmodal){
                    if(data["intervalList"][modal][submodal] != null){
                        //console.log("no es null");
                        $("#ModalIntervalsDiv").append("<div><span style='width:20px;height20px;background:"+colors[iSubmodal%colors.length]+"'>[ ]</span>"+submodal+"<br/></div>");
                    }
                });
                $("#ModalIntervalsDiv").append("<br/><div id='divinter"+numInterval+"' "+styleStr+"></div>"); //<h3>"+submodal+"</h3>
                $("#divinter"+numInterval).append("<canvas id='canvasinter"+numInterval+"' "+styleStr+"></canvas>");

                var dataOfChart = createModalIntervalsGraph(data["intervalList"][modal],
                        sScene,
                        modal,
                        iModal);
                //console.log(dataOfChart);
                new Chart(document.getElementById("canvasinter"+numInterval).getContext('2d'), dataOfChart);
                numInterval++;
            });


            var numInterval = 0;
                Object.keys(data["intervalList"]).map(function(modal, iModal){
                    $("#SubmodalIntervalsDiv").append("<br/><br/><h2>Tipo modal: "+modal+"</h2>");
                    Object.keys(data["intervalList"][modal]).map(function(submodal, iSubmodal){
                        if(data["intervalList"][modal][submodal] != null){
                            //console.log("no es null");
                            $("#SubmodalIntervalsDiv").append("<br/><div id='subdivinter"+numInterval+"' "+styleStr+"><h3>"+submodal+"</h3></div>"); //
                            $("#subdivinter"+numInterval).append("<canvas id='subcanvasinter"+numInterval+"' "+styleStr+"></canvas>");

                            var dataOfChart = createSubModalIntervalsGraph(data["intervalList"][modal][submodal],
                                    sScene,
                                    submodal,
                                    iSubmodal);
                            //console.log(dataOfChart);
                            new Chart(document.getElementById("subcanvasinter"+numInterval).getContext('2d'), dataOfChart);
                            numInterval++;
                        }
                    })
                });




                /*Eventos*/
                var numEvents = 0;
                Object.keys(data["eventList"]).map(function(modal, iModal){
                    $("#SubmodalEventsDiv").append("<br/><br/><h2>Tipo modal: "+modal+"</h2>");
                    Object.keys(data["eventList"][modal]).map(function(submodal, iSubmodal){
                        if(data["eventList"][modal][submodal] != null){
                            //console.log("no es null");
                            $("#SubmodalEventsDiv").append("<br/><div id='subdivev"+numEvents+"' "+styleStr+"><h3>"+submodal+"</h3></div>"); //
                            $("#subdivev"+numEvents).append("<canvas id='subcanvasev"+numEvents+"' "+styleStr+"></canvas>");
                            
                            chartData = [];
                            var decimationFactor = parseInt(String(data["eventList"][modal][submodal].length/100));
                            var decimationActual = 0;
                            var decimationArray = [];

                            for(var iEv in data["eventList"][modal][submodal]){
                                var myx = 1;
                                if(typeof(data["eventList"][modal][submodal][iEv]["Value"]) != typeof(undefined)){
                                    myx = data["eventList"][modal][submodal][iEv]["Value"];
                                }
                                decimationArray.push(myx);
                                if(decimationActual == decimationFactor || decimationActual == data["eventList"][modal][submodal].length -1 ){
                                    var realX = 0;
                                    for(var i in decimationArray){
                                        realX = realX + decimationArray[i];
                                    }
                                    realX = realX/decimationArray.length;
                                    
                                    var timeEvent = data["eventList"][modal][submodal][iEv]["EventTime"];
                                    var dEvent = Date.parse("1970-01-01T" + timeEvent + "Z");
                                    var cEvent = new Date(dEvent);
                                    var sEvent = cEvent.getUTCHours()*60*60+cEvent.getUTCMinutes()*60+cEvent.getUTCSeconds()+cEvent.getUTCMilliseconds()/1000.0;


                                    chartData.push({y: realX, x: sEvent});

                                    decimationActual = 0;
                                    decimationArray = [];
                                }
                                decimationActual++;
                                
                            }
                            //console.log(chartData);
                            //console.log(dataOfChart);
                            new Chart(document.getElementById("subcanvasev"+numEvents).getContext('2d'), {
                                type: 'line',
                                data: {
                                    datasets: [{
                                        data: chartData
                                    }]
                                },
                                options: {
                                    animation: {
                                        duration: 0
                                    },
                                    legend : {
                                        display : false
                                    },
                                    scales: {
                                        xAxes: [{
                                            type: 'linear',
                                            position: 'bottom',
                                            ticks : {
                                                beginAtzero :true,
                                                max: sScene,
                                                min: 0, 
                                                callback: function(value, index, values){
                                                    return parseInt(String(value/60))+":"+parseInt(String(((value/60)-parseInt(String(value/60)))*60))
                                                }
                                            }
                                        }],
                                        yAxes: [{
                                            type: 'linear',
                                        }]
                                    }
                                }
                            });
                            numEvents++;
                        }
                    })
            });


            var treeData = {};
            for(var inter in data["intervals"]){
                var interval = data["intervals"][inter];
                if(interval["ModalName"] != "Discrete Posture")
                    continue;
                if(!(interval["PersonName"] in treeData)){
                    treeData[interval["PersonName"]] = {
                        "name": interval["PersonName"],
                        "children": []
                    };
                }
                /*var ModalItIs = false;
                var childNumber = 0;
                for(var child in treeData[interval["PersonName"]]["children"]){
                    if(treeData[interval["PersonName"]]["children"][child]["name"] == interval["ModalName"]){
                        ModalItIs = true;
                        childNumber = child;
                    }
                }
                if(!ModalItIs){
                    childNumber = treeData[interval["PersonName"]]["children"].push({
                        "name": interval["ModalName"],
                        "children": []
                    });
                    childNumber = childNumber -1;
                }*/
                //console.log(childNumber);
                //console.log(interval["ModalName"]);
                //console.log(treeData[interval["PersonName"]]["children"]);
                var dInter = Date.parse("1970-01-01T" + interval["TotalDuration"] + "Z");
                var cInter = new Date(dInter);
                var sInter = parseInt(String(cInter.getUTCHours()*60*60+cInter.getUTCMinutes()*60+cInter.getUTCSeconds()+cInter.getUTCMilliseconds()/1000.0));
                treeData[interval["PersonName"]]["children"]/*[childNumber]["children"]*/.push({
                    "name": interval["SubModalName"],
                    /*"size": sInter*/
                    "children": [{
                        "name": interval["SubModalName"],
                        "size": sInter
                    }]
                });
            }
            for(var p in treeData){
                createTreeMap("treemap", treeData[p]);
            }


        });
  });
</script>
</html>