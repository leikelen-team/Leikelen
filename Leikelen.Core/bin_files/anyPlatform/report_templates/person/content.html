
<html>
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <script>
     Function.prototype.bind = Function.prototype.bind || function (thisp) {
        var fn = this;
        return function () {
            return fn.apply(thisp, arguments);
        };
    };
    </script>
    <script src="jquery-1.11.0.min.js"></script>
    <script src="Chart.bundle.min.js"></script>
    <script src="helpers.js"></script>
</head>
<body>
    <h1>Reporte de la Presentacion</h1>
    <h3>Posturas por estudiante</h3>
    <p>A continuación se muestra la cantidad de tiempo (porcentualmente) de cada postura</p>
    <div style="width:900px;height:600;">
        <canvas id="discretes" style="width:900px;height:600px"></canvas>
    </div>

    <h3>Voz, Inclinación del cuerpo y orientación del cuello</h3>
    <p>A continuación se muestra el tiempo que estuvo hablando, la inclinación de su cuerpo y si estuvo mirando al público</p>
    <div style="width:900px;height:600;">
        <canvas id="others" style="width:900px;height:600px"></canvas>
    </div>

    <h3>Distancias entre los participantes</h3>
    <p>A continuación se muestran los tipos de distancias entre los distintos participantes</p>
    <div style="width:900px;height:600;">
        <canvas id="proxemics" style="width:900px;height:600px"></canvas>
    </div>
</body>
<script>
    var colors = [
        'rgba(255, 0, 0, 0.5)',
        'rgba(0, 255, 0, 0.5)',
        'rgba(0, 0, 255, 0.5)',
        'rgba(126, 126, 126, 0.5)',
        'rgba(0, 126, 126, 0.5)',
        'rgba(126, 126, 0, 0.5)',
        'rgba(126, 0, 126, 0.5)',
        'rgba(55, 126, 55, 0.5)'
    ]
    function getLabels(data, modalNames, prefix){
        var labels = [];
        data.map(function(b) {
            if (modalNames.has(b["ModalName"])){
                if(prefix){
                    if(!labels.has(b["ModalName"]+" - "+b["SubModalName"]))
                        labels.push(b["ModalName"]+" - "+b["SubModalName"]);
                }
                else{
                    if(!labels.has(b["SubModalName"]))
                        labels.push(b["SubModalName"]);
                }
            }
        });
        return labels;
    }
    function getPersonData(data, modalNames, prefix, durationScene){
        var persons = {};
        data.map(function(b) {
            if (modalNames.has(b["ModalName"])){
                var d = Date.parse("1970-01-01T" + b["TotalDuration"] + "Z");
                var c = new Date(d);
                var s = c.getUTCHours()*60*60+c.getUTCMinutes()*60+c.getUTCSeconds()+c.getUTCMilliseconds()/1000.0;
                if(! (b["PersonName"] in persons))
                    persons[b["PersonName"]] = {}
                if(durationScene != 0)
                    s = s/durationScene;
                if(prefix)
                    persons[b["PersonName"]][b["ModalName"]+" - "+b["SubModalName"]] = s;
                else
                    persons[b["PersonName"]][b["SubModalName"]] = s;
            }
        });
        return persons;
    }
    function createBarChartData(persons, labels){
        var barChartData={};
        barChartData.labels = labels;
        barChartData.datasets = [];
        Object.keys(persons).map(function(p, i){
            d = {};
            d.label = p;
            d.borderWidth = 1;
            d.backgroundColor = colors[i]
            d.data = [];
            labels.map(function(l){
                if(l in persons[p]){
                    d.data.push(persons[p][l]);
                }else{
                    d.data.push(0);
                }
            });
            barChartData.datasets.push(d);
        });
        return barChartData;
    }
  $(function () {
    $.getJSON("dataJson.json")
        .done(function(data){

            var dScene = Date.parse("1970-01-01T" + data["scene"]["Duration"] + "Z");
            var c = new Date(dScene);
            var sScene = c.getUTCHours()*60*60+c.getUTCMinutes()*60+c.getUTCSeconds()+c.getUTCMilliseconds()/1000.0;
            /*Discrete postures*/
            var labels = getLabels(data["intervals"], ["Discrete Posture"], false);
            var persons = getPersonData(data["intervals"], ["Discrete Posture"], false, sScene);
            var barChartData = createBarChartData(persons, labels);
            

            new Chart(document.getElementById('discretes').getContext('2d'), {
                type: 'bar',
                data: barChartData,
                options: {
                    animation: {
                        duration: 0
                    }
                }
            })
            /*Voice, Neck Orientation, Lean, AccProxemic, Proxemic*/
            labels = getLabels(data["intervals"], ["Voice", "Neck Orientation", "Lean"], true);
            persons = getPersonData(data["intervals"], ["Voice", "Neck Orientation", "Lean"], true, sScene);
            barChartData = createBarChartData(persons, labels);

            new Chart(document.getElementById('others').getContext('2d'), {
                type: 'bar',
                data: barChartData,
                options: {
                    animation: {
                        duration: 0
                    }
                }
            })

            /*Proxemic*/
            labels = getLabels(data["intervals"], ["AccProxemic", "Proxemic"], true);
            persons = getPersonData(data["intervals"], ["AccProxemic", "Proxemic"], true, sScene);
            barChartData = createBarChartData(persons, labels);

            new Chart(document.getElementById('proxemics').getContext('2d'), {
                type: 'bar',
                data: barChartData,
                options: {
                    animation: {
                        duration: 0
                    }
                }
            })

        });
  });
</script>
</html>